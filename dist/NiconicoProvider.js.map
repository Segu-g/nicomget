{"version":3,"file":"NiconicoProvider.js","sources":["../src/providers/niconico/WebSocketClient.ts","../src/providers/niconico/ProtobufParser.ts","../src/providers/niconico/MessageStream.ts","../src/providers/niconico/SegmentStream.ts","../src/providers/niconico/BackwardStream.ts","../src/providers/niconico/NiconicoProvider.ts"],"sourcesContent":["import { EventEmitter } from 'events';\nimport WebSocket from 'ws';\n\nexport interface WebSocketClientEvents {\n  messageServer: (viewUri: string) => void;\n  disconnect: (reason: string) => void;\n  error: (error: Error) => void;\n  open: () => void;\n  close: () => void;\n}\n\n/**\n * ニコニコ生放送の視聴WebSocket管理クラス。\n * startWatching送信、ping/pong応答、keepSeat定期送信を行う。\n */\nexport class WebSocketClient extends EventEmitter {\n  private ws: WebSocket | null = null;\n  private keepSeatInterval: ReturnType<typeof setInterval> | null = null;\n\n  constructor(private readonly webSocketUrl: string) {\n    super();\n  }\n\n  connect(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.ws = new WebSocket(this.webSocketUrl);\n\n      this.ws.on('open', () => {\n        this.sendStartWatching();\n        this.emit('open');\n        resolve();\n      });\n\n      this.ws.on('message', (data) => {\n        try {\n          const message = JSON.parse(data.toString());\n          this.handleMessage(message);\n        } catch {\n          // ignore parse errors\n        }\n      });\n\n      this.ws.on('error', (error) => {\n        this.emit('error', error);\n        reject(error);\n      });\n\n      this.ws.on('close', () => {\n        this.stopKeepSeat();\n        this.emit('close');\n      });\n    });\n  }\n\n  disconnect(): void {\n    this.stopKeepSeat();\n    if (this.ws) {\n      this.ws.close();\n      this.ws = null;\n    }\n  }\n\n  private sendStartWatching(): void {\n    this.ws?.send(\n      JSON.stringify({\n        type: 'startWatching',\n        data: {\n          stream: {\n            quality: 'abr',\n            protocol: 'hls',\n            latency: 'low',\n            chasePlay: false,\n          },\n          room: {\n            protocol: 'webSocket',\n            commentable: false,\n          },\n          reconnect: false,\n        },\n      }),\n    );\n  }\n\n  private handleMessage(message: { type: string; data?: any }): void {\n    switch (message.type) {\n      case 'messageServer':\n        if (message.data?.viewUri) {\n          this.emit('messageServer', message.data.viewUri);\n        }\n        break;\n      case 'seat':\n        this.startKeepSeat(message.data?.keepIntervalSec ?? 30);\n        break;\n      case 'ping':\n        this.ws?.send(JSON.stringify({ type: 'pong' }));\n        break;\n      case 'disconnect':\n        this.emit('disconnect', message.data?.reason ?? 'unknown');\n        break;\n      case 'error':\n        this.emit('error', new Error(message.data?.message ?? 'WebSocket error'));\n        break;\n    }\n  }\n\n  private startKeepSeat(intervalSec: number): void {\n    this.stopKeepSeat();\n    const clamped = Math.max(10, Math.min(300, Number(intervalSec) || 30));\n    this.keepSeatInterval = setInterval(() => {\n      this.ws?.send(JSON.stringify({ type: 'keepSeat' }));\n    }, clamped * 1000);\n  }\n\n  private stopKeepSeat(): void {\n    if (this.keepSeatInterval) {\n      clearInterval(this.keepSeatInterval);\n      this.keepSeatInterval = null;\n    }\n  }\n}\n","import protobuf from 'protobufjs/minimal.js';\nconst { Reader } = protobuf;\n\n/**\n * Proto定義 (n-air-app/nicolive-comment-protobuf v2025.1117.170000):\n *   ChunkedEntry { oneof: segment=1(MessageSegment), backward=2(BackwardSegment), previous=3, next=4(ReadyForNext) }\n *   MessageSegment { from=1(Timestamp), until=2(Timestamp), uri=3(string) }\n *   ReadyForNext { at=1(int64) }\n *   BackwardSegment { until=1(Timestamp), segment=2(PackedSegment.Next), snapshot=3(StateSnapshot) }\n *   PackedSegment { messages=1(repeated ChunkedMessage), next=2(Next), snapshot=3(StateSnapshot) }\n *   PackedSegment.Next { uri=1(string) }\n *   ChunkedMessage { meta=1(Meta), oneof payload: message=2(NicoliveMessage), state=4(NicoliveState), signal=5(Signal) }\n *   NicoliveMessage { oneof data: chat=1, simple_notification=7, gift=8, nicoad=9,\n *     tag_updated=17, moderator_updated=18, ssng_updated=19, overflowed_chat=20,\n *     forwarded_chat=22, simple_notification_v2=23, akashic_message_event=24 }\n *   Chat { content=1, name=2, vpos=3, account_status=4, raw_user_id=5, hashed_user_id=6, modifier=7, no=8 }\n *   SimpleNotification { emotion=3(string), program_extension=5(string) }\n *   SimpleNotificationV2 { type=1(NotificationType), message=2(string), show_in_telop=3(bool), show_in_list=4(bool) }\n *   NotificationType { UNKNOWN=0, ICHIBA=1, EMOTION=2, CRUISE=3, PROGRAM_EXTENDED=4,\n *     RANKING_IN=5, VISITED=6, SUPPORTER_REGISTERED=7, USER_LEVEL_UP=8, USER_FOLLOW=9 }\n *   Gift { item_id=1, advertiser_user_id=2, advertiser_name=3, point=4, message=5, item_name=6, contribution_rank=7 }\n *   NicoliveState { statistics=1, enquete=2, move_order=3, marquee=4(Marquee), comment_lock=5,\n *     comment_mode=6, trial_panel=7, program_status=9, ... }\n *   Marquee { display=1(Display) }\n *   Display { operator_comment=1(OperatorComment) }\n *   OperatorComment { content=1, name=2, modifier=3, link=4 }\n *   Signal { FLUSHED=0 }\n */\n\n/** メッセージサイズ上限 (16 MB) — これを超えるメッセージは破棄する */\nconst MAX_MESSAGE_SIZE = 16 * 1024 * 1024;\n\n/** ニコニコ固有のChat生データ */\nexport interface NicoChat {\n  no: number;\n  vpos: number;\n  content: string;\n  name?: string;\n  rawUserId?: number;\n  hashedUserId?: string;\n}\n\n/** ニコニコ固有のGift生データ */\nexport interface NicoGift {\n  itemId: string;\n  advertiserUserId?: number;\n  advertiserName: string;\n  point: number;\n  message: string;\n  itemName: string;\n  contributionRank?: number;\n}\n\n/** ニコニコ固有のエモーション (SimpleNotificationV2 type=EMOTION) */\nexport interface NicoEmotion {\n  content: string;\n}\n\n/** SimpleNotificationV2 の通知タイプ (EMOTION 以外) */\nexport type NicoNotificationType =\n  | 'unknown'\n  | 'ichiba'\n  | 'cruise'\n  | 'program_extended'\n  | 'ranking_in'\n  | 'visited'\n  | 'supporter_registered'\n  | 'user_level_up'\n  | 'user_follow';\n\n/** ニコニコ固有の通知 (SimpleNotificationV2 type!=EMOTION) */\nexport interface NicoNotification {\n  type: NicoNotificationType;\n  message: string;\n}\n\n/** ニコニコ固有の放送者コメント */\nexport interface NicoOperatorComment {\n  content: string;\n  name?: string;\n  link?: string;\n}\n\n/** BackwardSegmentの解析結果 */\nexport interface BackwardSegmentResult {\n  segmentUri?: string;\n}\n\n/** ChunkedEntryの解析結果 */\nexport interface ChunkedEntryResult {\n  segmentUri?: string;\n  nextAt?: string;\n  backward?: BackwardSegmentResult;\n}\n\n/** PackedSegmentの解析結果 */\nexport interface PackedSegmentResult {\n  messages: ChunkedMessageResult[];\n  nextUri?: string;\n}\n\n/** ChunkedMessageの解析結果 */\nexport interface ChunkedMessageResult {\n  chats: NicoChat[];\n  gifts: NicoGift[];\n  emotions: NicoEmotion[];\n  notifications: NicoNotification[];\n  operatorComment?: NicoOperatorComment;\n  signal?: 'flushed';\n}\n\n/**\n * Length-Delimitedバッファから1メッセージを読み取る。\n * データ不足の場合はnullを返す。\n */\nexport function readLengthDelimitedMessage(\n  buffer: Uint8Array,\n): { message: Uint8Array; bytesRead: number } | null {\n  if (buffer.length === 0) return null;\n\n  try {\n    const reader = new Reader(buffer);\n    const messageLength = reader.uint32();\n    const headerSize = reader.pos;\n\n    if (messageLength > MAX_MESSAGE_SIZE) {\n      throw new Error(`Message size ${messageLength} exceeds limit ${MAX_MESSAGE_SIZE}`);\n    }\n\n    if (buffer.length < headerSize + messageLength) return null;\n\n    const message = buffer.slice(headerSize, headerSize + messageLength);\n    return { message, bytesRead: headerSize + messageLength };\n  } catch {\n    return null;\n  }\n}\n\n/**\n * バッファからすべてのLength-Delimitedメッセージを抽出する。\n * 残りのバッファも返す。\n */\nexport function extractMessages(\n  buffer: Uint8Array,\n): { messages: Uint8Array[]; remaining: Uint8Array } {\n  const messages: Uint8Array[] = [];\n  let offset = 0;\n\n  while (offset < buffer.length) {\n    const result = readLengthDelimitedMessage(buffer.slice(offset));\n    if (!result) break;\n    messages.push(result.message);\n    offset += result.bytesRead;\n  }\n\n  return { messages, remaining: buffer.slice(offset) };\n}\n\n/**\n * ChunkedEntryをパースする。\n * メッセージサーバーから返るデータ。\n *\n * field 1: segment (MessageSegment) - セグメントURI\n * field 2: backward (BackwardSegment) - スキップ\n * field 3: previous (MessageSegment) - 過去セグメント\n * field 4: next (ReadyForNext) - 次のストリーム接続時刻\n */\nexport function parseChunkedEntry(data: Uint8Array): ChunkedEntryResult {\n  const reader = new Reader(data);\n  const result: ChunkedEntryResult = {};\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (wireType !== 2) {\n      reader.skipType(wireType);\n      continue;\n    }\n\n    const len = reader.uint32();\n    const subData = reader.buf.slice(reader.pos, reader.pos + len);\n    reader.pos += len;\n\n    switch (field) {\n      case 1: // segment (MessageSegment)\n      case 3: // previous (MessageSegment)\n        if (!result.segmentUri) {\n          result.segmentUri = parseMessageSegmentUri(subData);\n        }\n        break;\n      case 2: // backward (BackwardSegment)\n        result.backward = parseBackwardSegment(subData);\n        break;\n      case 4: // next (ReadyForNext)\n        result.nextAt = parseReadyForNext(subData);\n        break;\n    }\n  }\n\n  return result;\n}\n\n/**\n * MessageSegment: from=1(Timestamp), until=2(Timestamp), uri=3(string)\n */\nfunction parseMessageSegmentUri(data: Uint8Array): string | undefined {\n  const reader = new Reader(data);\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n    if (field === 3 && wireType === 2) {\n      return reader.string();\n    }\n    reader.skipType(wireType);\n  }\n  return undefined;\n}\n\n/**\n * ReadyForNext: at=1(int64)\n */\nfunction parseReadyForNext(data: Uint8Array): string | undefined {\n  const reader = new Reader(data);\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n    if (field === 1 && wireType === 0) {\n      const v = reader.int64();\n      const num = typeof v === 'number' ? v : Number(v);\n      return String(num);\n    }\n    reader.skipType(wireType);\n  }\n  return undefined;\n}\n\n/**\n * ChunkedMessageをパースする。\n * セグメントサーバーから返るデータ。\n *\n * field 1: meta (Meta)\n * field 2: message (NicoliveMessage)\n * field 4: state (NicoliveState)\n * field 5: signal (Signal)\n */\nexport function parseChunkedMessage(data: Uint8Array): ChunkedMessageResult {\n  const reader = new Reader(data);\n  const result: ChunkedMessageResult = { chats: [], gifts: [], emotions: [], notifications: [] };\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (field === 2 && wireType === 2) {\n      // message (NicoliveMessage)\n      const len = reader.uint32();\n      const msgData = reader.buf.slice(reader.pos, reader.pos + len);\n      reader.pos += len;\n      const msg = parseNicoliveMessage(msgData);\n      if (msg) {\n        if (msg.chat) result.chats.push(msg.chat);\n        if (msg.gift) result.gifts.push(msg.gift);\n        if (msg.emotion) result.emotions.push(msg.emotion);\n        if (msg.notification) result.notifications.push(msg.notification);\n      }\n    } else if (field === 4 && wireType === 2) {\n      // state (NicoliveState)\n      const len = reader.uint32();\n      const stateData = reader.buf.slice(reader.pos, reader.pos + len);\n      reader.pos += len;\n      const op = parseNicoliveState(stateData);\n      if (op) result.operatorComment = op;\n    } else if (field === 5 && wireType === 0) {\n      // signal (Signal enum)\n      const val = reader.int32();\n      if (val === 0) result.signal = 'flushed';\n    } else {\n      reader.skipType(wireType);\n    }\n  }\n\n  return result;\n}\n\n/** NicoliveMessage解析の中間結果 */\ninterface NicoliveMessageResult {\n  chat?: NicoChat;\n  gift?: NicoGift;\n  emotion?: NicoEmotion;\n  notification?: NicoNotification;\n}\n\n/**\n * NicoliveMessage: oneof data\n *   chat=1(Chat), simple_notification=7(SimpleNotification),\n *   gift=8(Gift), nicoad=9(Nicoad), overflow_chat=20(Chat),\n *   simple_notification_v2=23(SimpleNotificationV2)\n */\nfunction parseNicoliveMessage(data: Uint8Array): NicoliveMessageResult | null {\n  const reader = new Reader(data);\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (wireType === 2) {\n      const len = reader.uint32();\n      const subData = reader.buf.slice(reader.pos, reader.pos + len);\n      reader.pos += len;\n\n      switch (field) {\n        case 1: // chat (Chat)\n        case 20: // overflow_chat (Chat)\n          return { chat: parseChat(subData) };\n        case 7: // simple_notification (SimpleNotification)\n          {\n            const emotion = parseSimpleNotification(subData);\n            if (emotion) return { emotion };\n          }\n          break;\n        case 8: // gift (Gift)\n          return { gift: parseGift(subData) };\n        case 23: // simple_notification_v2 (SimpleNotificationV2)\n          return parseSimpleNotificationV2(subData);\n      }\n    } else {\n      reader.skipType(wireType);\n    }\n  }\n\n  return null;\n}\n\n/**\n * Chatメッセージをパースする。\n *\n * field 1: content (string)\n * field 2: name (string, optional)\n * field 3: vpos (int32)\n * field 4: account_status (enum)\n * field 5: raw_user_id (int64, optional)\n * field 6: hashed_user_id (string, optional)\n * field 7: modifier (Modifier)\n * field 8: no (int32)\n */\nfunction parseChat(data: Uint8Array): NicoChat {\n  const reader = new Reader(data);\n  const chat: NicoChat = { no: 0, vpos: 0, content: '' };\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    switch (field) {\n      case 1: // content (string)\n        if (wireType === 2) {\n          chat.content = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 2: // name (string, optional)\n        if (wireType === 2) {\n          chat.name = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 3: // vpos (int32)\n        if (wireType === 0) {\n          chat.vpos = reader.int32();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 5: // raw_user_id (int64, optional)\n        if (wireType === 0) {\n          const v = reader.int64();\n          chat.rawUserId = typeof v === 'number' ? v : Number(v);\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 6: // hashed_user_id (string, optional)\n        if (wireType === 2) {\n          chat.hashedUserId = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 8: // no (int32)\n        if (wireType === 0) {\n          chat.no = reader.int32();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      default:\n        reader.skipType(wireType);\n        break;\n    }\n  }\n\n  return chat;\n}\n\n/**\n * SimpleNotification: oneof emotion=3(string)\n */\nfunction parseSimpleNotification(data: Uint8Array): NicoEmotion | null {\n  const reader = new Reader(data);\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (field === 3 && wireType === 2) {\n      return { content: reader.string() };\n    }\n    reader.skipType(wireType);\n  }\n\n  return null;\n}\n\n/** NotificationType enum → NicoNotificationType 文字列マッピング */\nconst NOTIFICATION_TYPE_MAP: Record<number, NicoNotificationType> = {\n  0: 'unknown',\n  1: 'ichiba',\n  // 2 = EMOTION → emotion として返すため含まない\n  3: 'cruise',\n  4: 'program_extended',\n  5: 'ranking_in',\n  6: 'visited',\n  7: 'supporter_registered',\n  8: 'user_level_up',\n  9: 'user_follow',\n};\n\n/**\n * SimpleNotificationV2 (field 23):\n *   type=1(NotificationType), message=2(string), show_in_telop=3(bool), show_in_list=4(bool)\n *\n * type=EMOTION(2) → { emotion } を返す\n * その他 → { notification } を返す\n */\nfunction parseSimpleNotificationV2(data: Uint8Array): NicoliveMessageResult | null {\n  const reader = new Reader(data);\n  let type = 0;\n  let message = '';\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    switch (field) {\n      case 1: // type (NotificationType enum)\n        if (wireType === 0) {\n          type = reader.int32();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 2: // message (string)\n        if (wireType === 2) {\n          message = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      default:\n        reader.skipType(wireType);\n        break;\n    }\n  }\n\n  if (type === 2) {\n    // EMOTION\n    return { emotion: { content: message } };\n  }\n\n  const typeName = NOTIFICATION_TYPE_MAP[type] ?? 'unknown';\n  return { notification: { type: typeName, message } };\n}\n\n/**\n * Gift: item_id=1, advertiser_user_id=2, advertiser_name=3, point=4, message=5, item_name=6, contribution_rank=7\n */\nfunction parseGift(data: Uint8Array): NicoGift {\n  const reader = new Reader(data);\n  const gift: NicoGift = {\n    itemId: '',\n    advertiserName: '',\n    point: 0,\n    message: '',\n    itemName: '',\n  };\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    switch (field) {\n      case 1: // item_id (string)\n        if (wireType === 2) {\n          gift.itemId = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 2: // advertiser_user_id (int64, optional)\n        if (wireType === 0) {\n          const v = reader.int64();\n          gift.advertiserUserId = typeof v === 'number' ? v : Number(v);\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 3: // advertiser_name (string)\n        if (wireType === 2) {\n          gift.advertiserName = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 4: // point (int64)\n        if (wireType === 0) {\n          const v = reader.int64();\n          gift.point = typeof v === 'number' ? v : Number(v);\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 5: // message (string)\n        if (wireType === 2) {\n          gift.message = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 6: // item_name (string)\n        if (wireType === 2) {\n          gift.itemName = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 7: // contribution_rank (int32, optional)\n        if (wireType === 0) {\n          gift.contributionRank = reader.int32();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      default:\n        reader.skipType(wireType);\n        break;\n    }\n  }\n\n  return gift;\n}\n\n/**\n * NicoliveState: marquee=4(Marquee)\n */\nfunction parseNicoliveState(data: Uint8Array): NicoOperatorComment | null {\n  const reader = new Reader(data);\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (field === 4 && wireType === 2) {\n      const len = reader.uint32();\n      const subData = reader.buf.slice(reader.pos, reader.pos + len);\n      reader.pos += len;\n      return parseMarquee(subData);\n    }\n    reader.skipType(wireType);\n  }\n\n  return null;\n}\n\n/**\n * Marquee: display=1(Display)\n */\nfunction parseMarquee(data: Uint8Array): NicoOperatorComment | null {\n  const reader = new Reader(data);\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (field === 1 && wireType === 2) {\n      const len = reader.uint32();\n      const subData = reader.buf.slice(reader.pos, reader.pos + len);\n      reader.pos += len;\n      return parseDisplay(subData);\n    }\n    reader.skipType(wireType);\n  }\n\n  return null;\n}\n\n/**\n * Display: operator_comment=1(OperatorComment)\n */\nfunction parseDisplay(data: Uint8Array): NicoOperatorComment | null {\n  const reader = new Reader(data);\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (field === 1 && wireType === 2) {\n      const len = reader.uint32();\n      const subData = reader.buf.slice(reader.pos, reader.pos + len);\n      reader.pos += len;\n      return parseOperatorComment(subData);\n    }\n    reader.skipType(wireType);\n  }\n\n  return null;\n}\n\n/**\n * OperatorComment: content=1, name=2, modifier=3, link=4\n */\nfunction parseOperatorComment(data: Uint8Array): NicoOperatorComment {\n  const reader = new Reader(data);\n  const result: NicoOperatorComment = { content: '' };\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    switch (field) {\n      case 1: // content (string)\n        if (wireType === 2) {\n          result.content = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 2: // name (string, optional)\n        if (wireType === 2) {\n          result.name = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      case 4: // link (string, optional)\n        if (wireType === 2) {\n          result.link = reader.string();\n        } else {\n          reader.skipType(wireType);\n        }\n        break;\n      default:\n        reader.skipType(wireType);\n        break;\n    }\n  }\n\n  return result;\n}\n\n/**\n * BackwardSegment: until=1(Timestamp), segment=2(PackedSegment.Next), snapshot=3(StateSnapshot)\n * PackedSegment.Next: { uri=1(string) }\n */\nfunction parseBackwardSegment(data: Uint8Array): BackwardSegmentResult {\n  const reader = new Reader(data);\n  const result: BackwardSegmentResult = {};\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (field === 2 && wireType === 2) {\n      const len = reader.uint32();\n      const subData = reader.buf.slice(reader.pos, reader.pos + len);\n      reader.pos += len;\n      result.segmentUri = parseUriField(subData);\n    } else {\n      reader.skipType(wireType);\n    }\n  }\n\n  return result;\n}\n\n/**\n * URI サブメッセージ: { uri=1(string) }\n * PackedSegment.Next や BackwardSegment.segment で使用。\n */\nfunction parseUriField(data: Uint8Array): string | undefined {\n  const reader = new Reader(data);\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n    if (field === 1 && wireType === 2) {\n      return reader.string();\n    }\n    reader.skipType(wireType);\n  }\n  return undefined;\n}\n\n/**\n * PackedSegmentをパースする。\n * BackwardSegment の segment URI から取得される RAW protobuf データ。\n *\n * field 1: messages (repeated ChunkedMessage)\n * field 2: next (PackedSegment.Next) — 次のPackedSegment URI\n * field 3: snapshot (StateSnapshot) — スキップ\n */\nexport function parsePackedSegment(data: Uint8Array): PackedSegmentResult {\n  const reader = new Reader(data);\n  const result: PackedSegmentResult = { messages: [] };\n\n  while (reader.pos < reader.len) {\n    const tag = reader.uint32();\n    const field = tag >>> 3;\n    const wireType = tag & 7;\n\n    if (wireType !== 2) {\n      reader.skipType(wireType);\n      continue;\n    }\n\n    const len = reader.uint32();\n    const subData = reader.buf.slice(reader.pos, reader.pos + len);\n    reader.pos += len;\n\n    switch (field) {\n      case 1: // messages (repeated ChunkedMessage)\n        result.messages.push(parseChunkedMessage(subData));\n        break;\n      case 2: // next (PackedSegment.Next)\n        result.nextUri = parseUriField(subData);\n        break;\n      // field 3 (snapshot): skip\n    }\n  }\n\n  return result;\n}\n","import { EventEmitter } from 'events';\nimport {\n  extractMessages,\n  parseChunkedEntry,\n} from './ProtobufParser.js';\n\n/** バッファサイズ上限 (16 MB) */\nconst MAX_BUFFER_SIZE = 16 * 1024 * 1024;\n\n/** HTTP接続タイムアウト (30秒) */\nconst CONNECT_TIMEOUT_MS = 30_000;\n\n/** ストリーミング無通信タイムアウト (60秒) */\nconst INACTIVITY_TIMEOUT_MS = 60_000;\n\n/**\n * メッセージサーバーHTTPストリーミング。\n * viewUri に接続し ChunkedEntry を解析、segmentUri と nextAt を通知する。\n */\nexport class MessageStream extends EventEmitter {\n  private buffer = new Uint8Array(0);\n  private controller: AbortController | null = null;\n\n  constructor(\n    private readonly viewUri: string,\n    private readonly cookies?: string,\n  ) {\n    super();\n  }\n\n  /** ストリーミング開始（at パラメータ指定） */\n  async start(at: string = 'now'): Promise<void> {\n    const separator = this.viewUri.includes('?') ? '&' : '?';\n    const uri = `${this.viewUri}${separator}at=${at}`;\n    this.controller = new AbortController();\n\n    // 接続フェーズのみのタイムアウト（ヘッダ受信後にクリア）\n    const connectTimer = setTimeout(() => {\n      this.controller?.abort();\n    }, CONNECT_TIMEOUT_MS);\n\n    try {\n      const headers: Record<string, string> = {\n        'User-Agent':\n          'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n        Priority: 'u=1, i',\n      };\n      if (this.cookies) headers['Cookie'] = this.cookies;\n\n      const response = await fetch(uri, {\n        headers,\n        signal: this.controller.signal,\n      });\n\n      clearTimeout(connectTimer);\n\n      if (!response.ok || !response.body) {\n        throw new Error(`Message server returned ${response.status}`);\n      }\n\n      const reader = response.body.getReader();\n      await this.readStream(reader);\n    } catch (error) {\n      clearTimeout(connectTimer);\n      if ((error as Error).name !== 'AbortError') {\n        this.emit('error', error);\n      }\n    }\n  }\n\n  stop(): void {\n    this.controller?.abort();\n    this.controller = null;\n    this.buffer = new Uint8Array(0);\n  }\n\n  private async readStream(\n    reader: ReadableStreamDefaultReader<Uint8Array>,\n  ): Promise<void> {\n    let inactivityTimer: ReturnType<typeof setTimeout> | null = null;\n\n    const resetInactivityTimer = () => {\n      if (inactivityTimer) clearTimeout(inactivityTimer);\n      inactivityTimer = setTimeout(() => {\n        this.stop();\n        this.emit('error', new Error('Stream inactivity timeout'));\n      }, INACTIVITY_TIMEOUT_MS);\n    };\n\n    try {\n      resetInactivityTimer();\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n        resetInactivityTimer();\n        this.handleData(value);\n      }\n      this.emit('end');\n    } catch (error) {\n      if ((error as Error).name !== 'AbortError') {\n        this.emit('error', error);\n      }\n    } finally {\n      if (inactivityTimer) clearTimeout(inactivityTimer);\n    }\n  }\n\n  /** @internal テスト用に公開 */\n  handleData(chunk: Uint8Array): void {\n    const combined = new Uint8Array(this.buffer.length + chunk.length);\n    combined.set(this.buffer, 0);\n    combined.set(chunk, this.buffer.length);\n\n    const { messages, remaining } = extractMessages(combined);\n    this.buffer = new Uint8Array(remaining);\n\n    if (this.buffer.length > MAX_BUFFER_SIZE) {\n      this.buffer = new Uint8Array(0);\n      this.emit('error', new Error(`Buffer size exceeded limit (${MAX_BUFFER_SIZE} bytes)`));\n      this.stop();\n      return;\n    }\n\n    let nextAt: string | undefined;\n\n    for (const msg of messages) {\n      try {\n        const entry = parseChunkedEntry(msg);\n        if (entry.segmentUri) {\n          this.emit('segment', entry.segmentUri);\n        }\n        if (entry.backward?.segmentUri) {\n          this.emit('backward', entry.backward.segmentUri);\n        }\n        if (entry.nextAt) {\n          nextAt = entry.nextAt;\n        }\n      } catch {\n        // malformed protobuf — skip\n      }\n    }\n\n    // nextAt は全 segment を処理した後に発火\n    // (next ハンドラが removeAllListeners() を呼ぶため)\n    if (nextAt) {\n      this.emit('next', nextAt);\n    }\n  }\n}\n","import { EventEmitter } from 'events';\nimport {\n  extractMessages,\n  parseChunkedMessage,\n  type NicoChat,\n  type NicoGift,\n  type NicoEmotion,\n  type NicoNotification,\n  type NicoOperatorComment,\n} from './ProtobufParser.js';\n\n/** バッファサイズ上限 (16 MB) */\nconst MAX_BUFFER_SIZE = 16 * 1024 * 1024;\n\n/** HTTP接続タイムアウト (30秒) */\nconst CONNECT_TIMEOUT_MS = 30_000;\n\n/** ストリーミング無通信タイムアウト (60秒) */\nconst INACTIVITY_TIMEOUT_MS = 60_000;\n\n/**\n * セグメントサーバーHTTPストリーミング。\n * セグメントURIに接続し ChunkedMessage を解析、各種メッセージを通知する。\n */\nexport class SegmentStream extends EventEmitter {\n  private buffer = new Uint8Array(0);\n  private controller: AbortController | null = null;\n\n  constructor(\n    private readonly segmentUri: string,\n    private readonly cookies?: string,\n  ) {\n    super();\n  }\n\n  async start(): Promise<void> {\n    this.controller = new AbortController();\n\n    // 接続フェーズのみのタイムアウト（ヘッダ受信後にクリア）\n    const connectTimer = setTimeout(() => {\n      this.controller?.abort();\n    }, CONNECT_TIMEOUT_MS);\n\n    try {\n      const headers: Record<string, string> = {\n        'User-Agent':\n          'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n      };\n      if (this.cookies) headers['Cookie'] = this.cookies;\n\n      const response = await fetch(this.segmentUri, {\n        headers,\n        signal: this.controller.signal,\n      });\n\n      clearTimeout(connectTimer);\n\n      if (!response.ok || !response.body) {\n        throw new Error(`Segment server returned ${response.status}`);\n      }\n\n      const reader = response.body.getReader();\n      await this.readStream(reader);\n    } catch (error) {\n      clearTimeout(connectTimer);\n      if ((error as Error).name !== 'AbortError') {\n        this.emit('error', error);\n      }\n    }\n  }\n\n  stop(): void {\n    this.controller?.abort();\n    this.controller = null;\n    this.buffer = new Uint8Array(0);\n  }\n\n  private async readStream(\n    reader: ReadableStreamDefaultReader<Uint8Array>,\n  ): Promise<void> {\n    let inactivityTimer: ReturnType<typeof setTimeout> | null = null;\n\n    const resetInactivityTimer = () => {\n      if (inactivityTimer) clearTimeout(inactivityTimer);\n      inactivityTimer = setTimeout(() => {\n        this.stop();\n        this.emit('error', new Error('Stream inactivity timeout'));\n      }, INACTIVITY_TIMEOUT_MS);\n    };\n\n    try {\n      resetInactivityTimer();\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n        resetInactivityTimer();\n        this.handleData(value);\n      }\n      this.emit('end');\n    } catch (error) {\n      if ((error as Error).name !== 'AbortError') {\n        this.emit('error', error);\n      }\n    } finally {\n      if (inactivityTimer) clearTimeout(inactivityTimer);\n    }\n  }\n\n  /** @internal テスト用に公開 */\n  handleData(chunk: Uint8Array): void {\n    const combined = new Uint8Array(this.buffer.length + chunk.length);\n    combined.set(this.buffer, 0);\n    combined.set(chunk, this.buffer.length);\n\n    const { messages, remaining } = extractMessages(combined);\n    this.buffer = new Uint8Array(remaining);\n\n    if (this.buffer.length > MAX_BUFFER_SIZE) {\n      this.buffer = new Uint8Array(0);\n      this.emit('error', new Error(`Buffer size exceeded limit (${MAX_BUFFER_SIZE} bytes)`));\n      this.stop();\n      return;\n    }\n\n    for (const msg of messages) {\n      try {\n        const result = parseChunkedMessage(msg);\n        for (const chat of result.chats) {\n          this.emit('chat', chat);\n        }\n        for (const gift of result.gifts) {\n          this.emit('gift', gift);\n        }\n        for (const emotion of result.emotions) {\n          this.emit('emotion', emotion);\n        }\n        for (const notification of result.notifications) {\n          this.emit('notification', notification);\n        }\n        if (result.operatorComment) {\n          this.emit('operatorComment', result.operatorComment);\n        }\n      } catch {\n        // malformed protobuf — skip\n      }\n    }\n  }\n}\n","import { EventEmitter } from 'events';\nimport {\n  parsePackedSegment,\n  type ChunkedMessageResult,\n} from './ProtobufParser.js';\n\n/** チェーン追跡の最大深度 */\nconst MAX_CHAIN_DEPTH = 50;\n\n/** リクエスト間の待機時間 (ms) */\nconst FETCH_DELAY_MS = 100;\n\n/** レスポンスサイズ上限 (16 MB) */\nconst MAX_RESPONSE_SIZE = 16 * 1024 * 1024;\n\n/** HTTP接続タイムアウト (30秒) */\nconst CONNECT_TIMEOUT_MS = 30_000;\n\n/**\n * 過去コメント (BackwardSegment) 取得ストリーム。\n * PackedSegment URI チェーンを全て取得し、時系列順（古→新）にイベントを発火する。\n *\n * チェーンは新→旧の順で返されるため、全セグメントをバッファリングした後\n * 逆順に emit することで時系列順を保証する。\n */\nexport class BackwardStream extends EventEmitter {\n  private stopped = false;\n\n  constructor(\n    private readonly initialUri: string,\n    private readonly cookies?: string,\n  ) {\n    super();\n  }\n\n  async start(): Promise<void> {\n    // Phase 1: 全セグメントを取得（新→旧の順で蓄積される）\n    const segments: ChunkedMessageResult[][] = [];\n\n    let uri: string | undefined = this.initialUri;\n    let depth = 0;\n\n    while (uri && !this.stopped && depth < MAX_CHAIN_DEPTH) {\n      try {\n        const data = await this.fetchSegment(uri);\n        const packed = parsePackedSegment(data);\n        segments.push(packed.messages);\n\n        uri = packed.nextUri;\n        depth++;\n\n        if (uri && !this.stopped) {\n          await delay(FETCH_DELAY_MS);\n        }\n      } catch (error) {\n        if (!this.stopped) {\n          this.emit('error', error);\n        }\n        break;\n      }\n    }\n\n    if (this.stopped) return;\n\n    // Phase 2: 逆順に emit（古→新の時系列順）\n    for (let i = segments.length - 1; i >= 0; i--) {\n      for (const msg of segments[i]) {\n        if (this.stopped) return;\n        for (const chat of msg.chats) {\n          this.emit('chat', chat);\n        }\n        for (const gift of msg.gifts) {\n          this.emit('gift', gift);\n        }\n        for (const emotion of msg.emotions) {\n          this.emit('emotion', emotion);\n        }\n        for (const notification of msg.notifications) {\n          this.emit('notification', notification);\n        }\n        if (msg.operatorComment) {\n          this.emit('operatorComment', msg.operatorComment);\n        }\n      }\n    }\n\n    if (!this.stopped) {\n      this.emit('end');\n    }\n  }\n\n  stop(): void {\n    this.stopped = true;\n  }\n\n  private async fetchSegment(uri: string): Promise<Uint8Array> {\n    const controller = new AbortController();\n    const timer = setTimeout(() => controller.abort(), CONNECT_TIMEOUT_MS);\n\n    try {\n      const headers: Record<string, string> = {\n        'User-Agent':\n          'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n      };\n      if (this.cookies) headers['Cookie'] = this.cookies;\n\n      const response = await fetch(uri, {\n        headers,\n        signal: controller.signal,\n      });\n\n      clearTimeout(timer);\n\n      if (!response.ok) {\n        throw new Error(`Backward segment server returned ${response.status}`);\n      }\n\n      const buf = await response.arrayBuffer();\n      if (buf.byteLength > MAX_RESPONSE_SIZE) {\n        throw new Error(`Response size ${buf.byteLength} exceeds limit ${MAX_RESPONSE_SIZE}`);\n      }\n\n      return new Uint8Array(buf);\n    } catch (error) {\n      clearTimeout(timer);\n      throw error;\n    }\n  }\n}\n\nfunction delay(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n","import { EventEmitter } from 'events';\nimport type { ICommentProvider } from '../../interfaces/ICommentProvider.js';\nimport type { Comment, ConnectionState, Gift, Emotion, Notification, OperatorComment } from '../../interfaces/types.js';\nimport type { NicoChat, NicoGift, NicoEmotion, NicoNotification, NicoOperatorComment } from './ProtobufParser.js';\nimport { WebSocketClient } from './WebSocketClient.js';\nimport { MessageStream } from './MessageStream.js';\nimport { SegmentStream } from './SegmentStream.js';\nimport { BackwardStream } from './BackwardStream.js';\n\n/** バックログで取得するイベント種別 */\nexport type BacklogEventType = 'chat' | 'gift' | 'emotion' | 'notification' | 'operatorComment';\n\nexport interface NiconicoProviderOptions {\n  liveId: string;\n  cookies?: string;\n  maxRetries?: number;\n  retryIntervalMs?: number;\n  /** 過去コメント（バックログ）を取得するか（デフォルト: true） */\n  fetchBacklog?: boolean;\n  /** バックログで取得するイベント種別（デフォルト: ['chat'] — チャットのみ） */\n  backlogEvents?: BacklogEventType[];\n}\n\n/**\n * ニコニコ生放送コメントプロバイダー。\n * ICommentProvider を実装し、放送ページからコメントを取得する。\n */\nexport class NiconicoProvider extends EventEmitter implements ICommentProvider {\n  private readonly liveId: string;\n  private readonly cookies?: string;\n  private readonly maxRetries: number;\n  private readonly retryIntervalMs: number;\n  private readonly fetchBacklog: boolean;\n  private readonly backlogEvents: Set<BacklogEventType>;\n  private wsClient: WebSocketClient | null = null;\n  private messageStream: MessageStream | null = null;\n  private segmentStreams: SegmentStream[] = [];\n  private fetchedSegments = new Set<string>();\n  private backwardStream: BackwardStream | null = null;\n  private seenChatNos = new Set<number>();\n  private state: ConnectionState = 'disconnected';\n  private intentionalDisconnect = false;\n  private reconnectCount = 0;\n  private reconnectTimer: ReturnType<typeof setTimeout> | null = null;\n\n  constructor(options: NiconicoProviderOptions) {\n    super();\n    this.liveId = options.liveId;\n    this.cookies = options.cookies;\n    this.maxRetries = options.maxRetries ?? 5;\n    this.retryIntervalMs = options.retryIntervalMs ?? 5000;\n    this.fetchBacklog = options.fetchBacklog ?? true;\n    this.backlogEvents = new Set(options.backlogEvents ?? ['chat']);\n  }\n\n  async connect(): Promise<void> {\n    this.intentionalDisconnect = false;\n    this.setState('connecting');\n\n    try {\n      // Step 1: 放送ページからWebSocket URLを取得\n      const webSocketUrl = await this.fetchWebSocketUrl();\n\n      await this.connectWebSocket(webSocketUrl);\n      this.reconnectCount = 0;\n      this.setState('connected');\n    } catch (error) {\n      this.setState('error');\n      throw error;\n    }\n  }\n\n  private async connectWebSocket(webSocketUrl: string): Promise<void> {\n    this.wsClient = new WebSocketClient(webSocketUrl);\n\n    this.wsClient.on('messageServer', (viewUri: string) => {\n      this.startMessageStream(viewUri);\n    });\n\n    this.wsClient.on('disconnect', (reason: string) => {\n      this.emit('error', new Error(`Disconnected: ${reason}`));\n      this.setState('disconnected');\n    });\n\n    this.wsClient.on('error', (error: Error) => {\n      this.emit('error', error);\n    });\n\n    this.wsClient.on('close', () => {\n      if (!this.intentionalDisconnect) {\n        this.scheduleReconnect();\n      } else {\n        this.setState('disconnected');\n      }\n    });\n\n    await this.wsClient.connect();\n  }\n\n  disconnect(): void {\n    this.intentionalDisconnect = true;\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer);\n      this.reconnectTimer = null;\n    }\n    this.wsClient?.disconnect();\n    this.messageStream?.stop();\n    for (const s of this.segmentStreams) s.stop();\n    this.segmentStreams = [];\n    this.fetchedSegments.clear();\n    this.backwardStream?.stop();\n    this.backwardStream = null;\n    this.seenChatNos.clear();\n    this.wsClient = null;\n    this.messageStream = null;\n    this.setState('disconnected');\n  }\n\n  private setState(state: ConnectionState): void {\n    if (this.state !== state) {\n      this.state = state;\n      this.emit('stateChange', state);\n    }\n  }\n\n  private scheduleReconnect(): void {\n    if (this.reconnectCount >= this.maxRetries) {\n      this.emit('error', new Error(`Reconnection failed after ${this.maxRetries} attempts`));\n      this.setState('disconnected');\n      return;\n    }\n\n    this.reconnectCount++;\n    this.setState('connecting');\n\n    this.reconnectTimer = setTimeout(async () => {\n      this.reconnectTimer = null;\n      try {\n        const webSocketUrl = await this.fetchWebSocketUrl();\n        await this.connectWebSocket(webSocketUrl);\n        this.reconnectCount = 0;\n        this.setState('connected');\n      } catch {\n        this.scheduleReconnect();\n      }\n    }, this.retryIntervalMs);\n  }\n\n  /** 放送ページのHTMLからWebSocket URLを取得する */\n  private async fetchWebSocketUrl(): Promise<string> {\n    const url = `https://live.nicovideo.jp/watch/${this.liveId}`;\n    const headers: Record<string, string> = {\n      'User-Agent':\n        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n      Accept:\n        'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\n      'Accept-Language': 'ja,en-US;q=0.9,en;q=0.8',\n    };\n    if (this.cookies) headers['Cookie'] = this.cookies;\n\n    const response = await fetch(url, { headers, signal: AbortSignal.timeout(30_000) });\n    if (!response.ok) {\n      throw new Error(`Failed to fetch broadcast page: ${response.status}`);\n    }\n\n    const html = await response.text();\n    const match = html.match(/id=\"embedded-data\"\\s+data-props=\"([^\"]+)\"/);\n    if (!match) {\n      throw new Error('Could not find embedded data in the page');\n    }\n\n    const propsJson = match[1]\n      .replace(/&quot;/g, '\"')\n      .replace(/&amp;/g, '&')\n      .replace(/&lt;/g, '<')\n      .replace(/&gt;/g, '>');\n\n    const props = JSON.parse(propsJson);\n    const wsUrl = props.site?.relive?.webSocketUrl;\n    if (!wsUrl) {\n      throw new Error('WebSocket URL not found in broadcast data');\n    }\n\n    return wsUrl;\n  }\n\n  private startMessageStream(viewUri: string): void {\n    this.replaceMessageStream(viewUri, 'now');\n  }\n\n  private replaceMessageStream(viewUri: string, at: string): void {\n    if (this.messageStream) {\n      this.messageStream.removeAllListeners();\n      this.messageStream.stop();\n    }\n    this.messageStream = new MessageStream(viewUri, this.cookies);\n\n    this.messageStream.on('segment', (segmentUri: string) => {\n      this.startSegmentStream(segmentUri);\n    });\n\n    this.messageStream.on('backward', (backwardUri: string) => {\n      if (this.fetchBacklog) {\n        this.startBackwardStream(backwardUri);\n      }\n    });\n\n    this.messageStream.on('next', (nextAt: string) => {\n      this.replaceMessageStream(viewUri, nextAt);\n    });\n\n    this.messageStream.on('error', (error: Error) => {\n      this.emit('error', error);\n    });\n\n    this.messageStream.on('end', () => {\n      // ストリームが nextAt なしで終了した場合、現在時刻で再接続\n      this.replaceMessageStream(viewUri, 'now');\n    });\n\n    this.messageStream.start(at).catch((err) => this.emit('error', err));\n  }\n\n  private startSegmentStream(segmentUri: string): void {\n    if (this.fetchedSegments.has(segmentUri)) return;\n    this.fetchedSegments.add(segmentUri);\n\n    const segment = new SegmentStream(segmentUri, this.cookies);\n\n    segment.on('chat', (chat: NicoChat) => {\n      if (this.isDuplicateChat(chat)) return;\n      this.emit('comment', this.mapChat(chat));\n    });\n\n    segment.on('gift', (nicoGift: NicoGift) => {\n      this.emit('gift', this.mapGift(nicoGift));\n    });\n\n    segment.on('emotion', (nicoEmotion: NicoEmotion) => {\n      this.emit('emotion', this.mapEmotion(nicoEmotion));\n    });\n\n    segment.on('notification', (nicoNotif: NicoNotification) => {\n      this.emit('notification', this.mapNotification(nicoNotif));\n    });\n\n    segment.on('operatorComment', (nicoOp: NicoOperatorComment) => {\n      this.emit('operatorComment', this.mapOperatorComment(nicoOp));\n    });\n\n    segment.on('error', (error: Error) => {\n      this.emit('error', error);\n    });\n\n    segment.on('end', () => {\n      const idx = this.segmentStreams.indexOf(segment);\n      if (idx >= 0) this.segmentStreams.splice(idx, 1);\n    });\n\n    this.segmentStreams.push(segment);\n    segment.start().catch((err) => this.emit('error', err));\n  }\n\n  private startBackwardStream(backwardUri: string): void {\n    // 既に backward stream が動作中の場合はスキップ\n    if (this.backwardStream) return;\n\n    const backward = new BackwardStream(backwardUri, this.cookies);\n    this.backwardStream = backward;\n\n    if (this.backlogEvents.has('chat')) {\n      backward.on('chat', (chat: NicoChat) => {\n        if (this.isDuplicateChat(chat)) return;\n        this.emit('comment', this.mapChat(chat, true));\n      });\n    }\n\n    if (this.backlogEvents.has('gift')) {\n      backward.on('gift', (nicoGift: NicoGift) => {\n        this.emit('gift', this.mapGift(nicoGift, true));\n      });\n    }\n\n    if (this.backlogEvents.has('emotion')) {\n      backward.on('emotion', (nicoEmotion: NicoEmotion) => {\n        this.emit('emotion', this.mapEmotion(nicoEmotion, true));\n      });\n    }\n\n    if (this.backlogEvents.has('notification')) {\n      backward.on('notification', (nicoNotif: NicoNotification) => {\n        this.emit('notification', this.mapNotification(nicoNotif, true));\n      });\n    }\n\n    if (this.backlogEvents.has('operatorComment')) {\n      backward.on('operatorComment', (nicoOp: NicoOperatorComment) => {\n        this.emit('operatorComment', this.mapOperatorComment(nicoOp, true));\n      });\n    }\n\n    backward.on('error', (error: Error) => {\n      this.emit('error', error);\n    });\n\n    backward.on('end', () => {\n      if (this.backwardStream === backward) {\n        this.backwardStream = null;\n      }\n    });\n\n    backward.start().catch((err) => this.emit('error', err));\n  }\n\n  /** chat.no ベースの重複排除（no > 0 のみ対象） */\n  private isDuplicateChat(chat: NicoChat): boolean {\n    if (chat.no <= 0) return false;\n    if (this.seenChatNos.has(chat.no)) return true;\n    this.seenChatNos.add(chat.no);\n    return false;\n  }\n\n  private mapChat(chat: NicoChat, isHistory?: boolean): Comment {\n    const comment: Comment = {\n      id: String(chat.no),\n      content: chat.content,\n      userId: chat.hashedUserId || (chat.rawUserId ? String(chat.rawUserId) : undefined),\n      userName: chat.name,\n      timestamp: new Date(),\n      platform: 'niconico',\n      raw: chat,\n    };\n    if (isHistory) comment.isHistory = true;\n    return comment;\n  }\n\n  private mapGift(nicoGift: NicoGift, isHistory?: boolean): Gift {\n    const gift: Gift = {\n      itemId: nicoGift.itemId,\n      itemName: nicoGift.itemName,\n      userId: nicoGift.advertiserUserId ? String(nicoGift.advertiserUserId) : undefined,\n      userName: nicoGift.advertiserName,\n      point: nicoGift.point,\n      message: nicoGift.message,\n      timestamp: new Date(),\n      platform: 'niconico',\n      raw: nicoGift,\n    };\n    if (isHistory) gift.isHistory = true;\n    return gift;\n  }\n\n  private mapEmotion(nicoEmotion: NicoEmotion, isHistory?: boolean): Emotion {\n    const emotion: Emotion = {\n      id: nicoEmotion.content,\n      timestamp: new Date(),\n      platform: 'niconico',\n      raw: nicoEmotion,\n    };\n    if (isHistory) emotion.isHistory = true;\n    return emotion;\n  }\n\n  private mapNotification(nicoNotif: NicoNotification, isHistory?: boolean): Notification {\n    const notification: Notification = {\n      type: nicoNotif.type,\n      message: nicoNotif.message,\n      timestamp: new Date(),\n      platform: 'niconico',\n      raw: nicoNotif,\n    };\n    if (isHistory) notification.isHistory = true;\n    return notification;\n  }\n\n  private mapOperatorComment(nicoOp: NicoOperatorComment, isHistory?: boolean): OperatorComment {\n    const operatorComment: OperatorComment = {\n      content: nicoOp.content,\n      name: nicoOp.name,\n      link: nicoOp.link,\n      timestamp: new Date(),\n      platform: 'niconico',\n      raw: nicoOp,\n    };\n    if (isHistory) operatorComment.isHistory = true;\n    return operatorComment;\n  }\n}\n"],"names":["MAX_BUFFER_SIZE","CONNECT_TIMEOUT_MS","INACTIVITY_TIMEOUT_MS"],"mappings":"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"}